<!DOCTYPE html>
<html>

<head>
    <title>Multi-language integration testing made easy with Bazel</title>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport" />

    <meta name="keywords" content="">
    <meta name="author" content="Gary Mindlin Miguel">

    <link href="/css/blog.css" rel="stylesheet" />
    <link href="/css/trac.css" rel="stylesheet" />
    <link href="/css/markdown.css" rel="stylesheet" />
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>悲</text></svg>">
    
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HYFFNSQX76"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-HYFFNSQX76');
</script>

    
    <!-- MailerLite Universal -->
    <script>
        (function (w, d, e, u, f, l, n) {
            w[f] = w[f] || function () {
                (w[f].q = w[f].q || [])
                    .push(arguments);
            }, l = d.createElement(e), l.async = 1, l.src = u,
                n = d.getElementsByTagName(e)[0], n.parentNode.insertBefore(l, n);
        })
            (window, document, 'script', 'https://assets.mailerlite.com/js/universal.js', 'ml');
        ml('account', '371042');
    </script>
    <!-- End MailerLite Universal -->
    <!-- TODO: I can't get this to work in blog.css for some reason -->
    <style>
        .twitter svg {
            height: 0.8em;
        }
    </style>
</head>

<body>
    <div class="content">
        <div class='nav'>
    <ul class='wrap'>
        <li><a href='/'>Home</a></li>
        <li><a href='/blog'>Blog</a></li>
        <li><a href='/feed.xml'>RSS</a></li>
    </ul>
</div>
        <div class="front-matter">
            <div class="wrap">
                <h1>Multi-language integration testing made easy with Bazel</h1>
                <h4></h4>
                <div class="bylines">
                    <div class="byline">
                        <h3>Published</h3>
                        <p>2023-10-09</p>
                    </div>
                    <div align="right">
                        
                        <div class="discuss">
    discuss on
    
    <a href="https://twitter.com/garymigu/status/1711536345783677213">
        <img src="/assets/x-logo.png" alt="Twitter" width="24" height="24" />
    </a>
    
    
    <a href="https://news.ycombinator.com/item?id=37833728">
        <img src="/assets/y-combinator.png" alt="Hacker News" width="24" height="24" />
    </a>
    
</div>

                        
                        <button class="ml-onclick-form" onclick="ml('show', 'IUXI0E', true)">get new posts via
                            email</button>
                    </div>
                </div>
                <div class="clear"></div>
            </div>
        </div>
        <div class="wrap article">
            <p>When developing mlflow-go, a Go client for MLFlow, I realized integration testing was crucial to ensure correctness. Since the official MLFlow server and client are written in Python, such an integration test would involve multiple languages. Bazel made it easy to set up and automate a multi-language test.</p>

<p>Bazel is a build tool and test runner. There’s lots to love about Bazel, but in this case the useful things are:</p>
<ol>
  <li>It supports many programming languages.</li>
  <li>Its “data” and “runfiles” features enable one Bazel target to access other build outputs at run-time.</li>
  <li>It can automatically download all needed language compilers / runtimes and external dependencies.</li>
</ol>

<p>To understand why I wanted an integration test, I need to explain a little about the system under test. The client logs to and reads from a local file system. In a unit test, I can assert that the client is able to write and read back what it wrote, but I can’t assert that the files are in a format that the official MLFlow code will understand, since there is no specification of the file format. The fact that I can read my own handwriting is pretty useless if I’m writing you a letter and you can’t read it. A test that uses both the Go and Python client libraries can enforce compatibility.</p>

<p>Here’s pseudo-code<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> for the test I ended up writing:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for client_binary in (go, py):
  temp_dir := make_temp_dir()
  run client binary in a subprocess, pointing it to write to temp_dir
  use official MLFlow client library to read from temp_dir
  assert we read what we expect to read
</code></pre></div></div>

<p>The test is declared in a BUILD.bazel file<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>. Let’s walk through what’s in it. First we declare the binaries that write to MLFlow, using the Go and Python client libraries:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># go binary that uses our go client
</span><span class="n">go_binary</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"go"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"main.go"</span><span class="p">],</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s">"//:mlflow"</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># python binary that uses the official client
</span><span class="n">py_binary</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"py"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"main.py"</span><span class="p">],</span>
    <span class="n">main</span> <span class="o">=</span> <span class="s">"main.py"</span><span class="p">,</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s">"@pip//mlflow:pkg"</span><span class="p">],</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Then we declare the test, which depends on the above binaries as data:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">py_test</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"conformance_test"</span><span class="p">,</span>
    <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"conformance_test.py"</span><span class="p">],</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">":go"</span><span class="p">,</span>
        <span class="s">":py"</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">"@pip//mlflow:pkg"</span><span class="p">,</span>
        <span class="s">"@rules_python//python/runfiles"</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">data</code> field in the conformance_test target means bazel will build those targets when it builds the test, and the test can access them at run-time. To access them, we use Bazel’s runfiles module. In my conformance_test, to access the “py” target I would write:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">python.runfiles.runfiles</span>
<span class="c1"># converts relative path to absolute path
</span><span class="n">binary_path</span> <span class="o">=</span> <span class="n">python</span><span class="p">.</span><span class="n">runfiles</span><span class="p">.</span><span class="n">runfiles</span><span class="p">.</span><span class="n">Create</span><span class="p">().</span><span class="n">Rlocation</span><span class="p">(</span><span class="err">“</span><span class="n">_main</span><span class="o">/</span><span class="n">conformance</span><span class="o">/</span><span class="n">py</span><span class="err">”</span><span class="p">)</span>
</code></pre></div></div>

<p>Unfortunately the documentation for runfiles in Bazel is currently pretty bad (as it is for many topics), but the basic workflow is:
Add the target for what you want to access at runtime (which can be a built binary, in this case our “py” and “go” targets) to the <code class="language-plaintext highlighter-rouge">data</code> field of the accessor’s target declaration (in this case the “conformance_test”).
In the accessor’s code (in this case conformance_test.py), use a Bazel runfiles library to access the file.</p>

<p>Typically the “rules_&lt;lang&gt;” module that provides Bazel support for a given language includes a library to access runfiles. The one I used in my python test is “@rules_python//python/runfiles”.</p>

<p>Above I mentioned Bazel’s dependency management. In this case, the only thing a user needs to install is bazel. Then when the user runs <code class="language-plaintext highlighter-rouge">bazel test //conformance:conformance_test</code>, bazel will:
Download a specific version of the Go toolchain (compiler and linker)
Download a specific version of the Python interpreter
Download all external Go and Python dependencies
Use the above to build the needed targets
Runs the test</p>

<p>And this works on Linux, macOS, and Windows.</p>

<p>There you have it. Let me know if you find this useful.</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p><a href="https://github.com/Astera-org/mlflow-go/blob/master/conformance/conformance_test.py">Latest full source</a>. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>Slightly modified from the real thing for clarity, <a href="https://github.com/Astera-org/mlflow-go/blob/master/conformance/BUILD.bazel">latest full source here</a>. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

        </div>
        <div id="bibliography">
            <div class="wrap">
                <ol class="bibliography"></ol>
            </div>
        </div>
    </div>
</body>

</html>
